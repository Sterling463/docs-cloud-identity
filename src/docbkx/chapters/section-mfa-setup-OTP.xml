<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE glossary [
<!ENTITY % common SYSTEM "../../common/common.ent">
%common;
]>
<section 
  xmlns="http://docbook.org/ns/docbook"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  xmlns:xsdxt="http://docs.rackspacecloud.com/xsd-ext/v1.0"
  xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0"
  xml:id="proc_mfa_setup-OTP">
  <title>Configure Rackspace Cloud account for multi-factor authentication via OTP device</title>
  <para>Use these instructions to configure a Rackspace Cloud account for multi-factor
    authentication by using an OTP (one-time password) device.</para>
  <para>During the set up process, use the QR code generated by the Rackspace Identity Service
    to register the OTP device with a mobile passcode application. If you don't have an application available, download and install one of these: <itemizedlist>
      <listitem>
        <para><link xlink:href="https://support.google.com/accounts/answer/1066447?hl=en">Google
            Authenticator</link></para>
      </listitem>
      <listitem>
        <para><link xlink:href="https://www.authy.com/users">Authy</link> (Scroll down to the bottom
          of the page for application installation links.)</para>
      </listitem>
      <listitem>
        <para><link xlink:href="https://www.duosecurity.com/product/methods">Duo
          Mobile</link></para>
      </listitem>
    </itemizedlist></para>
<para>Run the following sequence of API operations to create, enable, and use an OTP device for multi-factor authentication.</para>
        
    <orderedlist>    
    <!-- Step 1 Authenticate -->
    <listitem xml:id="Step_authenticate-otp">
      <para>Authenticate to the Identity service.</para>
        <note><para>If you have multi-factor authentication configured on your account, follow the 
            <link xlink:href="proc_mfa_auth.html">multi-factor authentication process</link> to get 
            the authentication token. 
        </para>
        </note>
      <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl https://identity.api.rackspacecloud.com/v2.0/tokens \
       -X POST \
       -H "Accept: application/json" \
       -d '{"auth": {"passwordCredentials": {"username":"jqsmith", "password":"Password1"}}}' \ 
       -H "Content-Type: application/json"</programlisting>
              <para>The Identity service returns a 200 response that includes the authentication
                token ID.</para>
                <programlisting><![CDATA[< HTTP/1.1 200 OK
< Vary:  Accept, Accept-Encoding, X-Auth-Token
< Content-Type: application/json
< Content-Length: 375
< Server: Jetty(6.1.25)
< ]]>
{
    "access": {
        "serviceCatalog": [],
        "token": {
            "RAX-AUTH:authenticatedBy": [
                "PASSWORD"
            ],
            "expires": "YYYY-MM-DDT22:47:04.253-06:00",
            "id": "xxxxxxxxxxxxxxxxxxx"
        },
        "user": {
            "RAX-AUTH:defaultRegion": "ORD",
            "RAX-AUTH:federated": false,
            "id": "123452047fc14cc7bc977caa3cfff35f",
            "name": "jqsmith",
            "roles": [
                {
                    "description": "User Admin Role.",
                    "id": "3",
                    "name": "identity:user-admin"
                }
            ]
        }
    }
}</programlisting> 
    </listitem>
    <listitem>
            <para>Export the authentication token to an environment variables for use in subsequent operations.
                <?sbr?><programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> EXPORT AUTH_TOKEN="9b830c07c29f4d17a7e53d2341302218"</programlisting>
            </para>
    </listitem>  
    <!-- Step 2 Add an OTP device phone -->
    <listitem>
      <para>Add an OTP device to your account.</para>
      <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl $AUTH_URL/v2.0/users/$USER_ID/RAX-AUTH/multi-factor/otp-devices  \
       -X POST \
       -H "Content-Type: application/json" \
       -H "X-Auth-Token: $AUTH_TOKEN"
       -d '{"RAX-AUTH:otpDevice": { "name": "NewOTPDevice" }}' \ 
       | python -m json.tool</programlisting>
 <para>The Identity service returns a 201 response that
              includes a system-generated device ID and a QR code that you can use to add the device to the mobile passcode 
              application.<programlisting><![CDATA[< HTTP/1.1 201 Created
< Vary:  Accept, Accept-Encoding, X-Auth-Token
< Location: http://identity.api.rackspacecloud.com/cloud/v2.0/users/92bb036af5b0467198cded345597f6b4/RAX-AUTH/multi-factor/otp-devices/922e1bc14a0f4c9d94b2f26032312345
< Content-Type: application/json
< Content-Length: 93
< Server: Jetty(6.1.25)
<
{
    "RAX-AUTH:otpDevice": {
        "id": "94a1edf3bbe24cbc959512d46c112345",
        "keyUri": "otpauth://totp/Rackspace:myMobilePhone%20OTP1%20otp2?secret=SEIMNMGTH44S3ECHINDPU6OO7Y5IMJZM&issuer=Rackspace",
        "name": "myMobilePhone OTPdevice",
        "qrcode": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAoAAAAKAAQAAAAAktvSOAAADPUlEQVR42u3dQXLqMAwAULPiGByVHjXHYIV/hyaO5MSt6XT157HpQMljp4lkSSn1j18FCAQCgUAgEAgEAoFAIBAI/M/BR9lfl9cnH5fXh/f1f+u7Z7l+/e/1lXDRDQgEAufA7ZMv6bZdVBuR3RK+Ei8HAoHAH8GPcvK1jS+f7tIiVQPbrwCBQOAvwBCpSnmFrz201U/3foxpQCAQ+AvwdVEiMv+RsjcgEAh8D4yp2Zp+xSzssReJ6vu5HhAIBJ6UnWNO9t2f6To2EAgEDk7Gl3Zf1L4d6s1r+HrnjB4IBAJz+GpBab1ZKpfuipahrfWgVhYCAoHAKfAWasrxnql0764hGVslIBAInAbrfl+015RrCFF1LwQt6Z5pv4MCAoHASfC0Abn1IV+/zrrCu/UcrAKBQOBb4HZ0VbqA9dgLQeUSo9h+zg4EAoGT4DpjFYYfthmIEn+lhNSsbDdSqaMQCAQCfwDPT8j70k9O4lr1uYz7D4FAIPDkZukaMq3UEpgHr/aB8woEAoFvg93UQ25HTmXn0spCoXkQCAQCZ8HWuRPbcp5du2AoEm2p2WXQfwgEAoGjQtAjjVP15+zxkCtOY31TdgYCgcBjIag+97pObheM116P/YXDuVEgEAg8ZlJLGn5YBqlZOOvqMzQgEAicAmvoNT4eqceSdLut2r9yPgoBBAKBp/02keh3Gm8RLi/ySn+AQCBwAqxdGFq6EFXT3Hl97gfsZZSaAYFA4GB3333g9onaEk63ZkYhgEAg8GSFxcmcQ5+a3Y6tyt/sxAACgcBDapY2kN5zV0+IYv3DZca5HhAIBA7B2BlYDk92yDu77nmEAggEAqfBPOdQu0OupaVm/a5SIBAInATzK2wZzXGrO2dPGRoQCAROgP0jY/KW0RIejpeHJh6j1aNAIBA4XJhT20X12CeYN3j1uVwd330BgUDg4ZArzFj1T2+o9SSmlZN9XkAgEPgWWNIKi3KWmpWwrOvn8AUEAoGD8FXbCVZrQC7dg8UPZSEgEAicAWso9tzC6tHH/iyqvFY9DpwDgUDgJJjLznn3Vtw5WrpNFsPwBQQCgYMZ8D95AYFAIBAIBAKBQCAQCAQCgf8r+A/urJ6oeL",
        "verified": false
    }
}]]></programlisting></para>
    </listitem>
    
<!-- Step 3 - Export device-id and qrcode values -->  
    <listitem>
      <para>Export <code>id</code> and <code>qrcode</code> to environment variables for use in subsequent operations.
        <?sbr?><programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> EXPORT DEVICE_ID="94a1edf3bbe24cbc959512d46c112345</programlisting>
        <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> EXPORT qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAoAAAAKAAQAAAAAktvSOAAADPUlEQVR42u3dQXLqMAwAULPiGByVHjXHYIV/hyaO5MSt6XT157HpQMljp4lkSSn1j18FCAQCgUAgEAgEAoFAIBAI/M/BR9lfl9cnH5fXh/f1f+u7Z7l+/e/1lXDRDQgEAufA7ZMv6bZdVBuR3RK+Ei8HAoHAH8GPcvK1jS+f7tIiVQPbrwCBQOAvwBCpSnmFrz201U/3foxpQCAQ+AvwdVEiMv+RsjcgEAh8D4yp2Zp+xSzssReJ6vu5HhAIBJ6UnWNO9t2f6To2EAgEDk7Gl3Zf1L4d6s1r+HrnjB4IBAJz+GpBab1ZKpfuipahrfWgVhYCAoHAKfAWasrxnql0764hGVslIBAInAbrfl+015RrCFF1LwQt6Z5pv4MCAoHASfC0Abn1IV+/zrrCu/UcrAKBQOBb4HZ0VbqA9dgLQeUSo9h+zg4EAoGT4DpjFYYfthmIEn+lhNSsbDdSqaMQCAQCfwDPT8j70k9O4lr1uYz7D4FAIPDkZukaMq3UEpgHr/aB8woEAoFvg93UQ25HTmXn0spCoXkQCAQCZ8HWuRPbcp5du2AoEm2p2WXQfwgEAoGjQtAjjVP15+zxkCtOY31TdgYCgcBjIag+97pObheM116P/YXDuVEgEAg8ZlJLGn5YBqlZOOvqMzQgEAicAmvoNT4eqceSdLut2r9yPgoBBAKBp/02keh3Gm8RLi/ySn+AQCBwAqxdGFq6EFXT3Hl97gfsZZSaAYFA4GB3333g9onaEk63ZkYhgEAg8GSFxcmcQ5+a3Y6tyt/sxAACgcBDapY2kN5zV0+IYv3DZca5HhAIBA7B2BlYDk92yDu77nmEAggEAqfBPOdQu0OupaVm/a5SIBAInATzK2wZzXGrO2dPGRoQCAROgP0jY/KW0RIejpeHJh6j1aNAIBA4XJhT20X12CeYN3j1uVwd330BgUDg4ZArzFj1T2+ourJ6oeLlkhwAAAABJRU5ErkJggg=="</programlisting>
      </para>
    </listitem>
    
    <!-- Step 4 Add QR code to mobile passcode application -->    
    <listitem>
      <para>Add the QR code to the mobile passcode application by manually copying and pasting the
          <code>qrcode</code> value.</para>
      <para>For mobile passcode applications installed on a mobile phone, you can scan the QR code
        image into the application.  To use this method, create a file with the following html code <programlisting><![CDATA[<html>
<img alt="QR Code" src="$qrcode"/>
</html> ]]></programlisting>Replace the <code>$qrcode</code> variable with the value that you
        exported from the response to the create device API request. Then, open the page in a
        browser window, and use the scan feature in the mobile passcode application to confirm the
        pairing of the OTP device and the mobile passcode generator.</para>
      <para>This example shows an OTP device added to the Google Authenticator application on a
        mobile phone. <?sbr?><?sbr?><mediaobject>
          <imageobject>
            <imagedata fileref="../figures/otp-device.png" scale="40" format="PNG" align="center"/>
          </imageobject>
        </mediaobject><?sbr?></para>
    </listitem>
    <!--Step 5 Verify OTP device-->
    <listitem>
      <para>To verify the device, send the passcode generated by mobile passcode application to the
        OTP device.</para>
              <para>
                <programlisting language="bash" role="gutter: false"><?db-font-size 60%?>$ curl identity.api.rackspacecloud.com/v2.0/users/$USER_ID/RAX-AUTH/multi-factor/otp-devices/$DEVICE_ID/verify \
                  -X POST \
                  -d '{"RAX-AUTH:verificationCode": { "code": "$MOBILE_PASSCODE" }}' \
                  -H "Content-type: application/json" \
                  -H "X-Auth-Token: $TOKEN" -| python -m json.tool
    </programlisting>
                The &CIS; returns a 204 response.
                <screen>
                    <computeroutput>
                     HTTP/1.1 204 No Content
                    </computeroutput>
                </screen>
              </para>
              <para>If you provide an invalid or expired passcode, the &CIS; returns an error
                message. <code>400 The pin provided is either invalid or expired/</code>. If you get
                this message, wait for the passcode in the mobile passcode application to refresh,
                then resubmit the verify request.</para>
            </listitem>
    <!-- Step 6 Enable multi-factor authentication for mobile device -->
    <listitem>
      <para>Update the multi-factor authentication settings to use the OTP device for
                authentication. </para>
            <para>
        <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl identity.api.rackspacecloud.com/v2.0/users/$USER_ID/RAX-AUTH/multi-factor \
       -X PUT \
       -H "Content-Type: application/json" \
       -H "Accept: application/json" \
       -d '{"RAX-AUTH:multiFactor": {"factorType": "OTP" }}' \
       -H "X-Auth-Token: $AUTH_TOKEN" \
       | python -m json.tool</programlisting>
        The &CIS; returns a 204 response.
        <screen>
                    <computeroutput>
                     HTTP/1.1 204 No Content
                    </computeroutput>
                </screen>
        After you change the multi-factor authentication method, authenticate again to get a new
        token. </para>
    </listitem>
    <!-- Step 7 Verify phone request-->
    <listitem>
      <para>Submit an authentication request with username and passcode credentials.</para>
       <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl identity.api.rackspacecloud.com/v2.0   \
       -X POST \
       -H "Content-Type: application/json" \
       -H "Accept: application/json" \
       -d  '{"auth": {"passwordCredentials": {"username": "$USERNAME","password":"$PASSWORD"}}}'  \
       | python -m json.tool</programlisting>
              
       <para>The Identity service returns a 401 response with a <code>sessionId</code> header and a message requesting additional credentials.
         <programlisting><![CDATA[< HTTP/1.1 401 Unauthorized
< Content-Type: application/json
< Transfer-Encoding: chunked
< WWW-Authenticate: OS-MF sessionId='ABCDEtwrk4kUsZbPhiXrAD1uMR8B3fsTV6axb6XuddCRl1xsopPla6tSofC0wqWTuc39GzdeDnEUX9xTRM_QA_oYBaN2W9C782YY4-iyQUgqbCFrWbC5ezeEoDVWpWNyR6PARZJQsd7J5QktDQzB7zIwwFvwJVciFEb8kscU87-LNr-u8h7NwtYp30fqNLCZznPtbGWkGC2Pm', factor='PASSCODE'
< X-NewRelic-App-Data: PxQDVVVTDAATV1BXBAACVUYdFGQHBDcQUQxLA1tMXV1dORYzVBJHNQFUZAQUFVFQVThOFlhaUggXER5jLTU3SxJOCEwIFAQcA1QLUwVNHlNIFAZZUgZaVlVUUAADUFYFVgYUbg=='
< vary: Accept, Accept-Encoding, X-Auth-Token
{
    "unauthorized": {
        "code": 401,
        "message": "Additional authentication credentials required"
    }
} ]]></programlisting></para>
    </listitem>
    <!-- Step 8 Authenticate with sessionId and OTP credentials -->
    <listitem>
      <para>Submit a second authentication request with <code>sessionId</code> and <code>passcode</code> credentials.</para>
      <itemizedlist>  
      <listitem><para>Export the <code>sessionId</code> from the header in the initial authentication response.
          <?sbr?><programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt>EXPORT SESSION_ID="AABCDEtwrk4kUsZbPhiXrAD1uMR8B3fsTV6axb6XuddCRl1xsopPla6tSofC0wqWTuc39GzdeDnEUX9xTRM_QA_oYBaN2W9C782YY4-iyQUgqbCFrWbC5ezeEoDVWpWNyR6PARZJQsd7J5QktDQzB7zIwwFvwJVciFEb8kscU87-LNr-u8h7NwtYp30fqNLCZznPtbGWkGC2Pm"</programlisting>
        </para>
    </listitem>
        <listitem>
          <para>Include the session ID header and passcode from the mobile passcode application in the authentication request.</para>
          <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl identity.api.rackspacecloud.com/v2.0/tokens   \
       -X POST \
       -H "Content-Type: application/json" \
       -H "Accept: application/json" \
       -d '{"auth": {"RAX-AUTH:passcodeCredentials": {"passcode":"$MOBILE_PASSCODE"}}}'  \
       -H "X-SessionId: $SESSION_ID"
       -H "X-Auth-Token: $AUTH_TOKEN" \
       | python -m json.tool</programlisting>
        <para>In the authentication response, the token authentication method is
              <code>OTPPASSCODE</code>.<programlisting><![CDATA[< HTTP/1.1 200 OK
< Vary:  Accept, Accept-Encoding, X-Auth-Token
< Content-Type: application/json
< Content-Length: 375
< Server: Jetty(6.1.25)
< 
{
    "access": {
        "serviceCatalog": [],
        "token": {
            "RAX-AUTH:authenticatedBy": [
                "OTPPASSCODE",
                "PASSWORD"
            ],
            "expires": "2015-04-04T14:17:51.918Z",
            "id": "$TOKEN",
            "tenant": {
                "id": "2014073001",
                "name": "2014073001"
            }
        },
        "user": {
            "RAX-AUTH:defaultRegion": "ORD",
            "id": "xxxxxxxxxxxxxxxxxxx",
            "name": "jqsmith",
            "roles": [
                               {
                    "description": "A Role that allows a user access to keystone Service methods",
                    "id": "684",
                    "name": "compute:default",
                    "tenantId": "2014073001"
                },
                {
                    "description": "A Role that allows a user access to keystone Service methods",
                    "id": "5",
                    "name": "object-store:default",
                    "tenantId": "StagingUS_2014073001"
                },
                {
                    "description": "User Admin Role.",
                    "id": "3",
                    "name": "identity:user-admin"
                     }
            ]
        }
    }]]></programlisting>
          </para>
        </listitem>
        </itemizedlist>
    </listitem>
  </orderedlist>
  <para>For more information, see the following topics: <itemizedlist>
    <listitem>
      <para>
        <link xlink:href="proc_mfa_auth.html">Authenticate from a
          multifactor-enabled user account</link></para>
    </listitem>
    <listitem><para>
          <link xlink:href="proc_mfa_manage.html">Manage
            multifactor-enabled accounts</link></para></listitem>
    <listitem condition="admin">
      <para><link xlink:href="Multifactor_Calls.html">API
        reference: Multi-factor authentication
        operations</link></para>
    </listitem>
    <listitem condition="client">
      <para><link xlink:href="Multifactor_Calls_client.html">API
        reference: Multi-factor authentication
        operations</link></para>
    </listitem>
  </itemizedlist>
  </para>
</section>
