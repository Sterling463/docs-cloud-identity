<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE glossary [
<!ENTITY % common SYSTEM "../../common/common.ent">
%common;
]>
<section
  xmlns="http://docbook.org/ns/docbook"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  xmlns:xsdxt="http://docs.rackspacecloud.com/xsd-ext/v1.0"
  xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0"
  xml:id="proc_mfa_auth">
<title>Authenticate from a multifactor-enabled user account</title>
  <para>Use these instructions to authenticate to a Rackspace Cloud account that requires
    <link xlink:href="MFA_Ops.html">multi-factor authentication</link>.</para>
  <variablelist>
    <varlistentry>
      <term><emphasis role="bold">Prerequisites</emphasis></term>
      <listitem><para><itemizedlist>
        <listitem><para>Valid username and password credentials for a Rackspace Cloud account that has been <link
                  xlink:href="proc_mfa_setup.html">set up for multi-factor
                authentication</link>.</para></listitem>
        <listitem><para>Access to the phone associated with the &CLOUD; account.</para></listitem>
      </itemizedlist></para>
        <tip><para>If your account requires multi-factor authentication, make sure to <link
          xlink:href="proc_mfa_manage.html">generate bypass codes</link> that you can use to
          authenticate if you do not have  the phone associated with your account.</para></tip></listitem>
    </varlistentry>
  </variablelist>
  <orderedlist xml:id="mfa_auth_steps">
    <listitem>
      <para>Send a POST tokens authentication request to the Identity service with your
        <parameter>username</parameter> and <parameter>password</parameter>:
        <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl https://identity.api.rackspacecloud.com/v2.0/tokens  \
 -X POST \
 -d '{"auth":{"passwordCredentials":{"username":"myUserName","password":"thePassword"}}}' \
 -H "Content-type: application/json"  --verbose | python -m json.tool</programlisting></para>
    </listitem>  
    <listitem>
        <para>Retrieve the multi-factor authentication values generated by the Identity service. <itemizedlist>
          <listitem>
            <para>In the API response to the initial authentication request, locate the sesssion ID
              value in the <parameter>WWW-Authenticate</parameter> header parameter:
              <screen><computeroutput>
&lt; HTTP/1.1 401 Unauthorized
* Server Apache-Coyote/1.1 is not blacklisted
&lt; Server: Apache-Coyote/1.1
&lt; vary:  Accept, Accept-Encoding, X-Auth-Token
&lt; WWW-Authenticate: OS-MF sessionId='APU9ymMBWY5W-pTgnHuZEvjKsM5oG_ler4lC0g_EkCPYvPdUBHK55RWtsgpL5RZ22AyDNaVCNCz6mlDOwbJAI-RLFQywI7CgOvjH0MLhL5a6D-c4cd1x8BbZmy8uT8ejm7jzBUX_vDZ5R0Hcia5DkOB80yWNJ8XVKMxVYLg5Qwp0TPA2zx-HQOTM3xqVQE63u1mYDUqikrXQ', factor='PASSCODE'
&lt; Content-Type: application/json
&lt; Transfer-Encoding: chunked
&lt; Date: Thu, 13 Mar 2XXX 21:10:50 GMT
{ [data not shown]
100   186    0    96  100    90    159    149 --:--:-- --:--:-- --:--:--   159
* Connection #0 to host identity.api.rackspacecloud.com/v2.0 left intact
{
"unauthorized": {
    "code": 401,
    "message": "Additional authentication credentials required."
    }
}
    {
    "key":"value"
    } </computeroutput></screen></para>
          </listitem>
          <listitem>
            <para>Get the multi-factor authentication passcode value from the SMS message sent to
              the phone associated with the account.</para>
            <example>
                <title>SMS message with passcode</title><screen><computeroutput>Rackspace SMS passcodes (will expire in 10 minutes): 1411594</computeroutput></screen>
              </example>
          </listitem>
        </itemizedlist>
      </para>
      </listitem>
    
    <listitem><para>Send a second authentication request that includes the multi-factor
      authentication credentials: <parameter>sessionId</parameter> and
      <parameter>passcode</parameter>. 
      <variablelist>
        <varlistentry>
          <term><emphasis role="bold">cURL POST token request with
            multi-factor authentication 
            credentials</emphasis></term>
          <listitem>
            <para>
              <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt>curl https://identity.api.rackspacecloud.com/v2.0/tokens \
       -X POST \
       -d '{"auth": {"RAX-AUTH:passcodeCredentials": {"passcode":"1411594"}}}'\
       -H "X-SessionId: $SESSION_ID" \
       -H "Content-Type: application/json" --verbose | python -m json.tool</programlisting>
            </para>
            <para>The authentication response returns the
                authentication token ID and the service catalong with
                a list of available services. Note that the
                information returned in the <parameter>RAX-AUTH:
                  authenticated By</parameter> object shows
                authentication by both passcode and password.<programlisting><![CDATA[  < HTTP/1.1 200 OK
< Vary:  Accept, Accept-Encoding, X-Auth-Token
< Content-Type: application/json
< Content-Length: 375
< Server: Jetty(6.1.25)
< ]]>
{
    "access": {
        "serviceCatalog": [],
        "token": {
            "RAX-AUTH:authenticatedBy": [
                "PASSCODE",
                "PASSWORD"
            ],
            "expires": "2014-01-09T15:08:53.645-06:00",
            "id": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
        }, 
        "user": {
            "RAX-AUTH:defaultRegion": "ORD",
            "RAX-AUTH:federated": false,
            "RAX-AUTH:multiFactorEnabled": true,
            "id": "a64ee2047fc14cc7bc977caa3cfff35f",
            "name": "myUserName",
            "roles": [
                {
                    "description": "User Admin Role.",
                    "id": "3",
                    "name": "identity:user-admin"
                }
            ]
        }
    }
}</programlisting></para>
          </listitem>
        </varlistentry>
      </variablelist></para>
    </listitem>
  </orderedlist>
  <para>After you authenticate successfully, use the information in the response to <link
      xlink:href="QuickStart-000.html#submit_API_request">submit requests to Rackspace Cloud API
      services</link>. For additional information, see the following topics: <itemizedlist>
      <listitem>
        <para><link xlink:href="proc_mfa_setup.html">Set up multi-factor
          authentication</link></para>
      </listitem>
      <listitem>
        <para>Troubleshooting: <link xlink:href="proc_mfa_manage.html">Manage multi-factor
            authentication settings and operation</link></para>
      </listitem>
      <listitem condition="admin">
        <para><link xlink:href="Multifactor_Calls.html">API reference: Multi-factor authentication
            operations</link></para>
      </listitem>
      <listitem condition="client">
        <para><link xlink:href="Multifactor_Calls_client.html">API reference: Multi-factor
            authentication operations</link></para>
      </listitem>
    </itemizedlist></para> 
</section>
