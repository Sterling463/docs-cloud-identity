<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE glossary [
<!ENTITY % common SYSTEM "../../common/common.ent">
%common;
]>
<section xmlns="http://docbook.org/ns/docbook"
	xmlns:xi="http://www.w3.org/2001/XInclude"
	xmlns:xsdxt="http://docs.rackspacecloud.com/xsd-ext/v1.0"
	xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="mfa_processes"> 
    <title>Multifactor authentication set up, operation, and management</title>
    <para><xref linkend="mfa_process_summary"/> outlines the processes to set up, use, and manage
      multifactor authentication capabilities for &CLOUD; accounts using Identity service API
      operations. This work can be completed by using Identity Service API operations, or from  the
      Rackspace Cloud Control panel.</para>
    <para>For detailed instructions using the API operations that include 
      request and response examples, click the links in the task column.</para>
    <para>
      <table xml:id="mfa_process_summary" rules="all" width="100%">
        <caption>Multifactor authentication processes and procedures</caption>
        <col width="456pt"/>
        <col width="50%"/>
        <thead>
          <tr valign="top">
            <th>Task</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody>
          <tr valign="top">
            <td>
              <para><link linkend="proc_mfa_setup">Set up multifactor authentication</link><orderedlist>
                  <listitem>
                    <para>Authenticate to &CIS; to obtain an authentication token.</para>
                  </listitem>
                  <listitem>
                    <para>Add a mobile phone to your account.</para>
                  </listitem>
                  <listitem>
                    <para>Send a verification PIN code to your phone to verify the device.</para>
                  </listitem>
                  <listitem>
                    <para>Send the PIN code back to &CIS;.</para>
                  </listitem>
                  <listitem>
                    <para>Update your account to enable multifactor authentication support.</para>
                  </listitem>
                  <listitem>
                    <para>Review your account to make sure the phone is verified and multifactor
                      authentication is enabled.</para>
                  </listitem>
                </orderedlist></para>
            </td>
            <td><itemizedlist>
              <listitem><para>Requires a valid authentication token.</para>
              </listitem>
              <listitem><para>Each account can have only one phone number.</para></listitem>
                <listitem>
                  <para>The same phone number can be used for multiple accounts, but the phone must
                    be verified separately from each account.</para>
                </listitem>
                <listitem>
                  <para>After an account has been enabled with multifactor authentication, the user
                    must submit two requests to authenticate: an initial request with API key or
                    password credentials to obtain the multifactor credentials, followed by a
                    request with the multifactor credentials.</para>
                </listitem>
            </itemizedlist>
            </td>
          </tr>
          <tr valign="top">
            <td>
              <para><link linkend="proc_mfa_auth">Authenticate by phone</link><orderedlist>
                  <listitem>
                    <para>Authenticate to &CIS; by using either your password or API key.</para>
                  </listitem>
                  <listitem>
                    <para>If authentication is successful, &CIS; returns a 401 message with a
                      SessionId in the header and also sends an SMS passcode to the phone associated
                      with your account.</para>
                  </listitem>
                  <listitem>
                    <para>To complete the authentication process, submit another authentication
                      request with the SessionId in the header and the passcode in the request
                      body.</para>
                  </listitem>
                </orderedlist></para>
            </td>
            <td>
              <itemizedlist>
                <listitem>
                  <para>Requires a multifactor-enabled user account with a verified phone
                    number.</para>
                </listitem>
                <listitem>
                  <para>If user exceeds the maximum number of login attempts, the account is locked.
                  </para>
                </listitem>
              </itemizedlist>
            </td>
          </tr>
          <tr valign="top">
            <td>
              <para><link linkend="proc_mfa_manage">Manage multifactor settings and operation</link><itemizedlist>
                  <listitem>
                    <para>Unlock a user account.</para>
                  </listitem>
                  <listitem>
                    <para>Check the multifactor configuration on an account.</para>
                  </listitem>
                  <listitem>
                    <para>Enable or disable multifactor authentication capabilities.</para>
                  </listitem>
                  <listitem>
                    <para>Remove the multifactor configuration and any associated phones from an
                      account.</para>
                  </listitem>
                </itemizedlist></para>
            </td>
            <td>
              <itemizedlist>
                <listitem>
                  <para>Users cannot unlock their own accounts.</para>
                </listitem>
                <listitem>
                  <para>You can temporarily disable multifactor authentication, or delete all
                    multifactor settings and phones from an account.</para>
                </listitem>
              </itemizedlist>
            </td>
          </tr>
        </tbody>
      </table>
    </para>
    <section xml:id = "proc_mfa_setup">
      <title>Set up multifactor authentication</title>
      <para>Complete the following steps to set up multifactor authentication for a user account using Identity service API operations. 
        This process can also be completed from the Cloud Control panel.</para><important><para>Multifactor authentication is only supported by Rackspace Cloud Identity Service version 2.0 or later. 
          After an account is enabled for multifactor authentication, the user cannot authenticate from earlier API versions.</para></important>
      <orderedlist>
        
        <!-- Step 1 Authenticate -->
        <listitem xml:id="Step_authenticate">
          <para>Authenticate to &CIS; to obtain an authentication token.
            <variablelist>
            <varlistentry>
              <term><emphasis role="bold">POST tokens cURL request</emphasis>:</term>
              <listitem>
                <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl https://identity.api.rackspacecloud.com/v2.0/tokens \
       -X POST \
       -H "Content-Type: application/json" \
       -H "Accept: application/json" \
       -d '{"auth": {"passwordCredentials": {"username":"jqsmith", "password":"Password1"}}}' \ 
       | python -m json.tool</programlisting>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term><emphasis role="bold">Response with authentication
                  token id</emphasis>:</term>
              <listitem>
                <para>
                  <programlisting><![CDATA[  < HTTP/1.1 200 OK
< Vary:  Accept, Accept-Encoding, X-Auth-Token
< Content-Type: application/json
< Content-Length: 375
< Server: Jetty(6.1.25)
< ]]>
{
    "access": {
        "serviceCatalog": [],
        "token": {
            "RAX-AUTH:authenticatedBy": [
                "PASSWORD"
            ],
            "expires": "2013-12-17T22:47:04.253-06:00",
            "id": "xxxxx-yyyyy-xxxxxx-yyyyy-zzzzzzz"
        },
        "user": {
            "RAX-AUTH:defaultRegion": "ORD",
            "RAX-AUTH:federated": false,
            "id": "a64ee2047fc14cc7bc977caa3cfff35f",
            "name": "jqsmith",
            "roles": [
                {
                    "description": "User Admin Role.",
                    "id": "3",
                    "name": "identity:user-admin"
                }
            ]
        }
    }
}</programlisting>
                  <note>
                    <para>To run the cURL commands in these examples, export the authentication
                      token to an environment variable: <literal>export
                        AUTH_TOKEN=""xxxxx-yyyyy-xxxxxx-yyyyy-zzzzzzz"</literal> for example.</para>
                  </note>
                </para>
              </listitem>
            </varlistentry>
          </variablelist></para>
        </listitem>
        
        <!-- Step 2 Add a mobile phone -->
        <listitem>
          <para>Add a mobile phone to your account.<variablelist><varlistentry>
              <term><emphasis role="bold">cURL Add mobile phone
                  request</emphasis></term>
              <listitem>
                <para>
                  <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl $AUTH_URL/v2.0/users/$USER_ID/RAX-AUTH/multi-factor/mobile-phones  \
       -X POST \
       -H "Content-Type: application/json" \
       -d '{"RAX-AUTH:mobilePhone": { "number": "+1 512-555-1000" }}' \ 
       | python -m json.tool</programlisting>
                </para>
                <para>This operation does not return a response
                  body.</para>
              </listitem>
            </varlistentry></variablelist></para>
        </listitem>
        
        <!--Step 3 Verify PIN code -->
        <listitem>
          <para>Send a verification PIN code to your phone to verify the device.<variablelist>
            <varlistentry>
              <term><emphasis role="bold">cURL Send Verification code
                  request</emphasis></term>
              <listitem>
                <para>
                  <programlisting language="bash" role="gutter: false"><?db-font-size 60%?>$ curl $AUTH_URL/v2.0/users/$USER_ID/RAX-AUTH/multi-factor/mobile-phones/$PHONE_ID/verificationcode \
       -X POST \
       -H "Content-Type: application/json" \
       -H "Accept: application/json" \
       -H "X-Auth-Token: $AUTH_TOKEN"
       | python -m json.tool</programlisting>
                </para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term><emphasis role="bold">Response</emphasis></term>
              <listitem>
                <para>&CIS; returns ta 201 response and sends a message
                  like this to the designated phone number:</para>
                <para><code>To verify this mobile device for your
                  Rackspace profile used for multi-factor
                  authentication enter the PIN 1732</code>.</para>
              </listitem>
            </varlistentry>
          </variablelist></para>
        </listitem>
        <listitem>
          
          <!-- Step 4  Send verification code -->
          <para>Send the PIN code back to &CIS;.<variablelist>
            <varlistentry>
              <term><emphasis role="bold">cURL Send verification code
                  request</emphasis></term>
              <listitem>
                <para>
                  <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl $AUTH_URL/v2.0/users/$USER_ID/RAX-AUTH/multi-factor/mobile-phones/$PHONE_ID/verificationcode \
       -X POST \
       -H "Content-Type: application/json" \
       -H "X-Auth-Token: $AUTH_TOKEN" \
       | python -m json.tool</programlisting>
                </para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term><emphasis role="bold">Response</emphasis></term>
              <listitem>
                <para>&CIS; returns a 204 response.<programlisting><![CDATA[  < HTTP/1.1 202 Accepted
< Vary:  Accept, Accept-Encoding, X-Auth-Token
< Content-Type: application/json
< Server: Jetty(6.1.25) ]]></programlisting></para>
              </listitem>
            </varlistentry>
          </variablelist></para>
        </listitem>
        <!-- Step 5 Verify phone request-->
        <listitem>
          <para>Update your account to enable multifactor authentication support.<variablelist>
            <varlistentry>
              <term><emphasis role="bold">cURL Verify phone
                  request</emphasis></term>
              <listitem>
                <para>
                  <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl $AUTH_URL/v2.0/users/$USER_ID/RAX-AUTH/multi-factor/mobile-phones/$PHONE_ID/verify \
       -X POST \
       -H "Content-Type: application/json" \
       -H "Accept: application/json" \
       -d  -d '{"RAX-AUTH:verificationCode": { "code": "1832" }}' \
       -H "X-Auth-Token: $AUTH_TOKEN" \
       | python -m json.tool</programlisting>
                </para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term><emphasis role="bold">Response</emphasis></term>
              <listitem>
                <para>&CIS; returns a 204 response.<programlisting><![CDATA[  < HTTP/1.1 204 No Content
< Vary:  Accept, Accept-Encoding, X-Auth-Token
< Content-Type: application/json
< Server: Jetty(6.1.25) ]]></programlisting></para>
              </listitem>
            </varlistentry>
          </variablelist></para>
        </listitem>
        
        <!-- Step 6 Confirm account updates -->
        
        <listitem>
          <para>Review your account to make sure the phone is verified and multifactor
            authentication is enabled.
            <variablelist>
              <varlistentry>
              <term><emphasis role="bold">GET user by id cURL
                  request</emphasis></term>
              <listitem>
                <para>
                  <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl $AUTH_URL/v2.0/users/$USER_ID \
       -X GET \
       -H "Content-Type: application/json" \
       -H "X-Auth-Token: $AUTH_TOKEN" \
       | python -m json.tool</programlisting>
                </para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term><emphasis role="bold">Response showing
                    <code>RAX-AUTH:multiFactorEnabled=true</code></emphasis></term>
              <listitem><para><programlisting><![CDATA[  {
    "user": {
        "RAX-AUTH:defaultRegion": "ORD",
        "RAX-AUTH:domainId": 12345",
        "RAX-AUTH:multiFactorEnabled": true,
        "created": "2014-03-31T15:38:31.749-05:00",
        "email": "jqsmith@testmail.com",
        "enabled": true,
        "id": "a64ee2047fc14cc7bc977caa3cfff35f",
        "updated": "2014-03-31T15:47:11.895-05:00",
        "username": "jqsmith"
    }
} ]]></programlisting></para></listitem>
            </varlistentry>
            </variablelist></para>
        </listitem>
      </orderedlist></section>
     
    
    <section xml:id="proc_mfa_auth"><title>Authenticate from a multifactor-enabled user account</title>
      <para>Complete the following steps to authenticate to &CIS; using multifactor authentication credentials.</para>
      <variablelist>
        <varlistentry>
          <term><emphasis role="bold">Prerequisites</emphasis></term>
          <listitem><para><itemizedlist>
            <listitem><para>Valid credentials to authenticate to &CIS;.</para></listitem>
            <listitem><para>User account is enabled to use mulitifactor
                  authentication.</para></listitem>
            <listitem><para>Access to the phone linked to your &CLOUD; account.</para></listitem>
            <listitem><para>User account not locked as a result of too many failed
                  authentication attempts.</para></listitem>
          </itemizedlist>
          </para></listitem>
        </varlistentry>
      </variablelist>
      <orderedlist>
        <listitem>
          <para>Send a POST tokens authentication request to the Identity
          service with either Password or API credentials. See <xref
            linkend="Step_authenticate"/>.
          <variablelist>
            <varlistentry>
              <term><emphasis role="bold">Response</emphasis></term>
              <listitem>
                <para>The request triggers &CIS; to send an SMS
                  message to the phone associated with the user
                  account. In response to the authentication request,
                  &CIS; returns a 401 message that includes a
                  <code>sessionId</code> in the WWW-Authenticate header and a
                  request for additional
                  credentials:<screen><computeroutput>
&lt;&lt; HTTP/1.1 401 Unauthorized
* Server Apache-Coyote/1.1 is not blacklisted
&lt; Server: Apache-Coyote/1.1
&lt; vary:  Accept, Accept-Encoding, X-Auth-Token
&lt; WWW-Authenticate: OS-MF sessionId='APU9ymMBWY5W-pTgnHuZEvjKsM5oG_ler4lC0g_EkCPYvPdUBHK55RWtsgpL5RZ22AyDNaVCNCz6mlDOwbJAI-RLFQywI7CgOvjH0MLhL5a6D-c4cd1x8BbZmy8uT8ejm7jzBUX_vDZ5R0Hcia5DkOB80yWNJ8XVKMxVYLg5Qwp0TPA2zx-HQOTM3xqVQE63u1mYDUqikrXQ', factor='PASSCODE'
&lt; Content-Type: application/json
&lt; Transfer-Encoding: chunked
&lt; Date: Thu, 13 Mar 2XXX 21:10:50 GMT
{ [data not shown]
100   186    0    96  100    90    159    149 --:--:-- --:--:-- --:--:--   159
* Connection #0 to host identity.api.rackspacecloud.com/v2.0 left intact
{
"unauthorized": {
    "code": 401,
    "message": "Additional authentication credentials required."
    }
}
    {
    "key":"value"
    } </computeroutput></screen></para>
                <para>&CIS; also sends a message like this to your
                  phone:</para>
                <para><code>Rackspace SMS passcodes (will expire in 1
                    hour): 1411594</code>.</para>
              </listitem>
            </varlistentry>
          </variablelist></para></listitem>
      <listitem><para>Send another authentication request with the multifactor
          authentication credentials:
          &lt;code><code>sessionId</code>&lt;/code> and
            &lt;code><code>passcode</code>. <variablelist>
            <varlistentry>
              <term><emphasis role="bold">cURL POST token request with
                  multifactor authentication
                credentials</emphasis></term>
              <listitem>
                <para>
                  <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl https://identity.api.rackspacecloud.com/v2.0/tokens \
       -X POST \
       -H "Content-Type: application/json" \
       -H "Accept: application/json" \
       -d '{"auth": {"RAX-AUTH:passcodeCredentials": {"passcode":"1411594"}}}'
       -H "X-SessionId: APU9ymNjSKJG21HVdiRdOg0rk2fqh7uQ1FafVDXo3SId6nMHjUkKSDacFwDLGCC9U_DKI6Lwzu-wMi3LIWT-bA24EdGYdycM3rKzAfVPiCCjigN315ZLJo5s2TmiGQTSW9b5H7euQjJ6KBTk5elT2l8HrPH-9rrBjw" \
 		    | python -m json.tool</programlisting>
                </para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term><emphasis role="bold">Response</emphasis></term>
              <listitem>
                <para>&CIS; returns an authentication token id and
                  service catalog. Note that the information returned
                  in the <code>RAX-AUTH: authenticatedBy</code> object
                  shows authentication by both password and passcode.<programlisting><![CDATA[  < HTTP/1.1 200 OK
< Vary:  Accept, Accept-Encoding, X-Auth-Token
< Content-Type: application/json
< Content-Length: 375
< Server: Jetty(6.1.25)
< ]]>
{
    "access": {
        "serviceCatalog": [],
        "token": {
            "RAX-AUTH:authenticatedBy": [
                "PASSCODE",
                "PASSWORD"
            ],
            "expires": "2014-01-09T15:08:53.645-06:00",
            "id": "xxxxx-yyyyy-xxxxxx-yyyyy-zzzzzzz"
        }, 
        "user": {
            "RAX-AUTH:defaultRegion": "ORD",
            "RAX-AUTH:federated": false,
            "RAX-AUTH:multiFactorEnabled": true,
            "id": "a64ee2047fc14cc7bc977caa3cfff35f",
            "name": "jqsmith",
            "roles": [
                {
                    "description": "User Admin Role.",
                    "id": "3",
                    "name": "identity:user-admin"
                }
            ]
        }
    }
}</programlisting></para>
              </listitem>
            </varlistentry>
          </variablelist></para>
      </listitem>
      </orderedlist>
    </section>
  <section xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="proc_mfa_manage">
    <title>Manage multifactor authentication settings and operation</title>
    <para>This table describes the API operations for managing multifactor authentication 
      capabilities for &CLOUD; accounts and shows the cURL command to make the request. 
      For more detailed information about an operation, click the link in the task section.</para>
    <table xml:id="manage_mfa_ops" rules="all" width="100%">
      <caption>Multifactor authentication managment tasks</caption>
      <col/>
      <col/>
      <thead>
        <tr>
          <th>Task</th>
          <th>cURL command</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td valign="top">
            <para><link xlink:href ="PUT_unlockMultifactorForUser_v2.0_users__userId__RAX-AUTH_multi-factor_Multifactor_Calls.html">Unlock user account</link></para></td>
          <td valign="top">
            <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl https://identity.api.rackspacecloud.com/v2.0/users/$USER_ID \
       -X PUT  \
       -d '{"RAX-AUTH:multiFactor": { "unlock": "true" }}'
       -H "Content-Type: application/json" \
 		| python -m json.tool</programlisting>
          </td>
        </tr>
        <tr>
          <td valign="top">
            <para><link xlink:href="GET_getUserById_users_User_Calls.html">Check multifactor status on user account</link></para>
          </td>
          <td valign="top">
            <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl https://identity.api.rackspacecloud.com/v2.0/users/$USER_ID \
       -X POST \
       -H "Content-Type: application/json" \
 		| python -m json.tool</programlisting>
          </td>
        </tr>
        <tr>
          <td valign="top"><link xlink:href="GET_getMobilePhonesForUser_v2.0_users__userId__RAX-AUTH_multi-factor_mobile-phones_Multifactor_Calls.html">List multifactor-enabled devices by user id</link>
            </td>
          <td valign="top">
            <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl https://identity.api.rackspacecloud.com/v2.0/$USER_ID/RAX-AUTH/multi-factor/mobile-phones  \
       -X PUT \
       -H "Content-Type: application/json" \
 		| python -m json.tool</programlisting>
          </td>
        </tr>
        <tr>
          <td valign="top"><link
              xlink:href="PUT_updateMultifactorSettings_v2.0_users__userId__RAX-AUTH_multi-factor_mobile-phones_Multifactor_Calls.html"
              >Disable multifactor authentication</link></td>
          <td><para>cURL request to disable (<code>enabled=false</code>) multifactor
            for the specified user account.</para><programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl https://identity.api.rackspacecloud.com/v2.0/users/$USER_ID/RAX-AUTH/multi-factor \
       -X PUT \
       -d '{"RAX-AUTH:multiFactor": { "enabled": "false" }}' \
       -H "Content-Type: application/json" \
 		| python -m json.tool</programlisting></td>
        </tr>
        <tr>
          <td valign="top">
            <para><link xlink:href="DELETE_removeMultifactorForUser_v2.0_users__userId__RAX-AUTH_multi-factor_mobile-phones_Multifactor_Calls.html">Remove the multifactor settings and phone from a user account</link></para>
          </td>
          <td valign="top">
            <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl https://identity.api.rackspacecloud.com/v2.0/users/$USER_ID/RAX-AUTH/multifactor  \
       -X  DELETE  \
       -H "Content-Type: application/json" \
 		| python -m json.tool</programlisting>
          </td>
        </tr>
      </tbody>
    </table>
    <para>For detailed reference information about API service support for multifactor
      authentication resources and methods, see <olink targetdoc="Identity-Admin-Developer-Guide"
        targetptr="Multifactor_Calls">“API Operations for Service Developers: Multifactor
        operations”.</olink></para>  
  </section></section>
