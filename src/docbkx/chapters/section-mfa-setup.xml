<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE glossary [
<!ENTITY % common SYSTEM "../../common/common.ent">
%common;
]>
<section 
  xmlns="http://docbook.org/ns/docbook"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  xmlns:xsdxt="http://docs.rackspacecloud.com/xsd-ext/v1.0"
  xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0"
  xml:id="proc_mfa_setup">
  <title>Set up multi-factor authentication</title>
  <para>Use these instructions to set up multi-factor
    authentication for a user account using Identity service API
    operations. You can also complete this process through the Cloud Control panel.</para>

  <note><title>Notes</title>
    <itemizedlist>
      <listitem>
        <para>Multi-factor authentication is supported only by Rackspace
        Cloud Identity Service version 2.0 or later. After an account
        is enabled for multi-factor authentication, the user cannot
        authenticate using &CIS; v1.0 or v1.1. This feature is
        currently only available to customers enrolled in the Early
        Access program.</para>
      </listitem>
      <listitem><para>A user account can have only one phone number for use with
        multi-factor authentication. </para></listitem>
      <listitem>
        <para>The same phone number can be used for multiple
          accounts, but the phone must be verified separately
          for each account.</para>
      </listitem>
      <listitem><para>When a user account is updated to require multi-factor authentication, all existing tokens for
          the account obtained by using username and password credentials are revoked immediately.
          To regain access, the user must complete the multi-factor authentication process to
          generate a new token.</para></listitem>
    </itemizedlist>
  </note>
  <orderedlist>
    <!-- Step 1 Authenticate -->
    <listitem xml:id="Step_authenticate">
      <para>Authenticate to the Identity service to obtain an
        authentication token. <variablelist>
          <varlistentry>
            <term><emphasis role="bold">Request</emphasis></term>
            <listitem>
              <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl https://identity.api.rackspacecloud.com/v2.0/tokens \
       -X POST \
       -H "Accept: application/json" \
       -d '{"auth": {"passwordCredentials": {"username":"jqsmith", "password":"Password1"}}}' \ 
       -H "Content-Type: application/json"</programlisting>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term><emphasis role="bold">Response</emphasis></term>
            <listitem>
              <para>The Identity service returns a 200 response code
                that includes the authentication token ID.
                <programlisting><![CDATA[< HTTP/1.1 200 OK
< Vary:  Accept, Accept-Encoding, X-Auth-Token
< Content-Type: application/json
< Content-Length: 375
< Server: Jetty(6.1.25)
< ]]>
{
    "access": {
        "serviceCatalog": [],
        "token": {
            "RAX-AUTH:authenticatedBy": [
                "PASSWORD"
            ],
            "expires": "2013-12-17T22:47:04.253-06:00",
            "id": "xxxxxxxxxxxxxxxxxxx"
        },
        "user": {
            "RAX-AUTH:defaultRegion": "ORD",
            "RAX-AUTH:federated": false,
            "id": "a64ee2047fc14cc7bc977caa3cfff35f",
            "name": "jqsmith",
            "roles": [
                {
                    "description": "User Admin Role.",
                    "id": "3",
                    "name": "identity:user-admin"
                }
            ]
        }
    }
}</programlisting></para>
            </listitem>
          </varlistentry>
        </variablelist></para>
    </listitem>
    <!-- Step 2 Add a mobile phone -->
    <listitem>
      <para>Add a mobile phone to your account.<variablelist>
        <varlistentry>
          <term><emphasis role="bold">Request</emphasis></term>
          <listitem>
            <para>
              <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl $AUTH_URL/v2.0/users/$USER_ID/RAX-AUTH/multi-factor/mobile-phones  \
       -X POST \
       -H "Content-Type: application/json" \
       -H "X-Auth-Token: $AUTH_TOKEN"
       -d '{"RAX-AUTH:mobilePhone": { "number": "+1 512-555-1000" }}' \ 
       | python -m json.tool</programlisting>
            </para>
            <tip><para>Specify the phone number in 
              <link xlink:href="https://www.itu.int/rec/T-REC-E.123-200102-I/en">E.123 notation</link>, <code>+1 235 435
                6234</code> or <code>+44 42 1123 4567</code>,
              for example.</para></tip>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><emphasis role="bold">Response</emphasis></term>
          <listitem>
            <para>The Identity service returns a 201 response that
              includes the system-generated phone ID.<programlisting><![CDATA[< HTTP/1.1 201 Created
< Vary:  Accept, Accept-Encoding, X-Auth-Token
< Location: http://localhost:8083/idm/cloud/v2.0/users/a64ee2047fc14cc7bc977caa3cfff35f/RAX-AUTH/multi-factor/mobile-phones/889a7245f49e4ab789ebaebf91c0f1eb
< Content-Type: application/json
< Content-Length: 93
< Server: Jetty(6.1.25)
<
{
    "RAX-AUTH:mobilePhone": {
        "id": "1234321245f49e4ab789ebaebf91c0f1eb",
        "number": "+1 512-555-0100"
    }
} ]]></programlisting></para>
          </listitem>
        </varlistentry>
        
      </variablelist></para>
      <tip><para>Export the phone <parameter>id</parameter> value to an
        environment variable, so you can use it to complete the
        phone verification process:
        <?sbr?><programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> EXPORT PHONE_ID=""1234321245f49e4ab789ebaebf91c0f1eb"</programlisting></para></tip>
    </listitem>
    <!--Step 3 Verify PIN code -->
    <listitem>
      <para>Send a verification code to your phone to confirm that
        you possess the phone associated with your account. In the
        request, include the phone <parameter>id</parameter> value
        (or the $PHONE_ID environment variable that you exported)
        from the add mobile phone operation. from the Add mobile
        phone operation in this request.<variablelist>
          <varlistentry>
            <term><emphasis role="bold">Request</emphasis></term>
            <listitem>
              <para>
                <programlisting language="bash" role="gutter: false"><?db-font-size 60%?>$ curl $AUTH_URL/v2.0/users/$USER_ID/RAX-AUTH/multi-factor/mobile-phones/$PHONE_ID/verificationcode \
       -X POST \
       -H "Content-Type: application/json" \
       -H "Accept: application/json" \
       -H "X-Auth-Token: $AUTH_TOKEN"
       | python -m json.tool</programlisting>
              </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term><emphasis role="bold">Response</emphasis></term>
            <listitem>
              <para>&CIS; returns ta 201 response and sends a
                message like this to the designated phone
                number:</para>
              <para><code>To verify this mobile device for your
                Rackspace profile used for multi-factor
                authentication enter the PIN 1732</code>.</para>
            </listitem>
          </varlistentry>
        </variablelist></para>
    </listitem>
    <listitem>
      <!-- Step 4  Send verification code -->
      <para>Return the verification PIN code to complete the phone verification process.<variablelist>
        <varlistentry>
          <term><emphasis role="bold">Request</emphasis></term>
          <listitem>
            <para>
              <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl $AUTH_URL/v2.0/users/$USER_ID/RAX-AUTH/multi-factor/mobile-phones/$PHONE_ID/verify \
       -X POST \
       -H "Content-Type: application/json" \
       -H "Accept: application/json" \
       -d '{"RAX-AUTH:verificationCode": { "code": "1732" }}' \
       -H "X-Auth-Token: $AUTH_TOKEN" \
       | python -m json.tool</programlisting>
            </para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><emphasis role="bold">Response</emphasis></term>
          <listitem>
            <para>The Identity Service returns a 202 response.<programlisting><![CDATA[< HTTP/1.1 202 Accepted
< Vary:  Accept, Accept-Encoding, X-Auth-Token
< Content-Type: application/json
< Server: Jetty(6.1.25) ]]></programlisting></para>
          </listitem>
        </varlistentry>
      </variablelist></para>
    </listitem>
    <!-- Step 5 Verify phone request-->
    <listitem>
      <para>Update your account to enable multi-factor
        authentication support.<variablelist>
          <varlistentry>
            <term><emphasis role="bold">Request</emphasis></term>
            <listitem>
              <para>
                <programlisting language="bash" role="gutter: false"><?db-font-size 60%?><prompt>$</prompt> curl $AUTH_URL/v2.0/users/$USER_ID/RAX-AUTH/multi-factor \
       -X PUT \
       -H "Content-Type: application/json" \
       -H "Accept: application/json" \
       -d '{"RAX-AUTH:multiFactor": {"enabled": true }}' \
       -H "X-Auth-Token: $AUTH_TOKEN" \
       | python -m json.tool</programlisting>
              </para>
            </listitem>
          </varlistentry>
          <varlistentry>
            <term><emphasis role="bold">Response</emphasis></term>
            <listitem>
              <para>The Identity service returns a 204 response.<programlisting><![CDATA[< HTTP/1.1 204 No Content
< Vary:  Accept, Accept-Encoding, X-Auth-Token
< Content-Type: application/json
< Server: Jetty(6.1.25) ]]></programlisting></para>
            </listitem>
          </varlistentry>
        </variablelist></para>
    </listitem>
  </orderedlist>
  <para>For more information, see the following topics: <itemizedlist>
    <listitem>
      <para>
        <link xlink:href="proc_mfa_auth.html">Authenticate from a
          multifactor-enabled user account</link></para>
    </listitem>
    <listitem><para>
          <link xlink:href="proc_mfa_manage.html">Manage
            multifactor-enabled accounts</link></para></listitem>
    <listitem condition="admin">
      <para><link xlink:href="Multifactor_Calls.html">API
        reference: Multi-factor authentication
        operations</link></para>
    </listitem>
    <listitem condition="client">
      <para><link xlink:href="Multifactor_Calls_client.html">API
        reference: Multi-factor authentication
        operations</link></para>
    </listitem>
  </itemizedlist>
  </para>
</section>
